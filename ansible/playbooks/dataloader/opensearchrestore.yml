---
- name: Opensearch restore
  hosts: all
  connection: local
  gather_facts: yes
  remote_user: commonsdocker

  tasks:
    # Clone the required repository
    - name: Clone the devops repo
      git:
        repo: "https://github.com/CBIIT/datacommons-devops.git"
        dest: "/tmp/datacommons-devops"
        version: "v1.19"

    # Install collection from the local path after cloning
    - name: Install bento.common collection from local path
      ansible.builtin.shell: "ansible-galaxy collection install /tmp/datacommons-devops/ansible/collections/bento/common/ --force"

    # Load data
    - name: Perform opensearch backup
      include_role:
        name: bento.common.opensearch_dataloading
        tasks_from: opensearchrestore
      vars:
        workspace: "{{ lookup('env','WORKSPACE') }}"
        project_name:  "{{ lookup('env','PROJECT') }}"
        tier: "{{ lookup('env','ENV') }}"
        region: "{{ lookup('env','REGION') }}"
        opensearch_host: "https://{{ lookup('amazon.aws.aws_secret', 'bento/{{ project_name }}/{{ tier }}.es_host', nested=true, region='us-east-1' ) }}/"
        snapshot_repo: "{{ project_name }}"
        s3_bucket: "{{ lookup('env','S3_BUCKET') }}"
        snapshot_value: "{{ lookup('env','SNAPSHOT_NAME') }}"
        base_path: ""
        indices: "{{ lookup('env', 'INDICES') }}"
        role_arn: "{{ lookup('env', 'ROLE_ARN') }}"
